<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vive Quintay ADMIN</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0A2F4F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0A2F4F; color: white; }
        .card { background-color: #0D3B5C; border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid #1B263B; }
    </style>
</head>
<body class="p-4 font-sans">

    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-[#00E0D0]">VIVE QUINTAY</h1>
            <p class="text-gray-400 text-sm">Panel Administrativo</p>
        </div>
        <div class="bg-[#1B263B] p-2 rounded-lg text-center">
            <span id="fecha-actual" class="text-xs block">--/--/--</span>
            <span id="hora-sincro" class="text-[10px] text-[#00E0D0] block">Esperando datos...</span>
        </div>
    </header>

    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="card flex flex-col items-center">
            <span class="text-gray-400 text-xs uppercase">Hoy Recaudado</span>
            <span id="total-hoy" class="text-2xl font-bold text-[#00C853]">$0</span>
        </div>
        <div class="card flex flex-col items-center">
            <span class="text-gray-400 text-xs uppercase">Vehículos</span>
            <span id="cant-hoy" class="text-2xl font-bold text-[#FFD700]">0</span>
        </div>
    </div>

    <div class="card">
        <h2 class="text-center mb-4 font-semibold text-xs text-gray-400 uppercase">Distribución de Pagos (Hoy)</h2>
        <canvas id="chartPagos" style="max-height: 200px;"></canvas>
    </div>

    <div class="card">
        <h2 class="text-center mb-4 font-semibold text-xs text-gray-400 uppercase">Ingresos Últimos 7 Días</h2>
        <canvas id="chartSemanal" style="max-height: 200px;"></canvas>
    </div>

    <div class="card">
        <h2 class="mb-4 font-semibold text-xs text-gray-400 uppercase">Historial de Cierres</h2>
        <div id="lista-cierres" class="text-sm space-y-3">
            <p class="text-gray-500 italic">Cargando Firebase...</p>
        </div>
    </div>

    <div id="pantalla-bloqueo" class="fixed inset-0 z-[100] bg-[#0A2F4F] flex flex-col items-center justify-center p-6">
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-[#00E0D0] mb-2">VIVE QUINTAY</h1>
            <p class="text-gray-400">Acceso Administrativo</p>
        </div>
        <div class="w-full max-w-xs">
            <input type="password" id="input-pass" placeholder="Ingresa PIN" 
                class="w-full p-4 rounded-xl bg-[#1B263B] border border-[#00E0D0] text-white text-center text-2xl mb-4 focus:outline-none">
            <button id="btn-entrar" class="w-full p-4 bg-[#00E0D0] text-[#0A2F4F] font-bold rounded-xl active:scale-95 transition-transform">
                ENTRAR
            </button>
            <p id="error-pass" class="text-red-400 text-sm mt-4 text-center hidden">Clave incorrecta</p>
        </div>
    </div>

<script type="module">
    // 1. Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAXGH39g0gLBjVF0XHznEoDwG3O8xrD76k",
        authDomain: "vive-quintay-spa.firebaseapp.com",
        projectId: "vive-quintay-spa",
        storageBucket: "vive-quintay-spa.firebasestorage.app",
        messagingSenderId: "1016972577353",
        appId: "1:1016972577353:web:81a7a1af882c8296640d98",
        measurementId: "G-E0GZE2NWDD"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables globales para los gráficos
    let chartPagos;
    let chartSemanal;

    // --- FUNCIÓN: ESCUCHA DE DATOS HOY (TIEMPO REAL) ---
    function iniciarEscuchaDashboard() {
        // Escuchamos el documento que el Python actualiza cada 2 horas
        onSnapshot(doc(db, "admin_stats", "hoy"), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Actualizar números superiores
                document.getElementById('total-hoy').innerText = `$${data.total_hoy.toLocaleString('es-CL')}`;
                document.getElementById('cant-hoy').innerText = (data.cant_pases + data.cant_minutos);
                document.getElementById('hora-sincro').innerText = `Sincro: ${data.ultima_actualizacion}`;
                document.getElementById('fecha-actual').innerText = data.fecha_dato || new Date().toLocaleDateString('es-CL');

                // Actualizar Gráfico de Dona (Efectivo vs Tarjeta)
                actualizarGraficoPagos(data.efectivo, data.tarjeta);
            }
        });
    }

    // --- FUNCIÓN: CARGAR HISTÓRICO (ÚLTIMOS 7 DÍAS) ---
    function iniciarEscuchaHistoricos() {
        const q = query(collection(db, "historico_cierres"), orderBy("timestamp_cierre", "desc"), limit(7));
        
        onSnapshot(q, (snapshot) => {
            let labels = [];
            let montos = [];
            let html = "";

            snapshot.forEach((doc) => {
                const d = doc.data();
                labels.push(d.fecha);
                montos.push(d.total_recaudado);
                html += `
                    <div class="flex justify-between border-b border-gray-800 pb-2">
                        <span>${d.fecha}</span>
                        <span class="font-bold text-[#00C853]">$${d.total_recaudado.toLocaleString('es-CL')}</span>
                    </div>`;
            });

            document.getElementById('lista-cierres').innerHTML = html || "Sin cierres registrados";
            actualizarGraficoSemanal(labels.reverse(), montos.reverse());
        });
    }

    // --- LÓGICA DE GRÁFICOS (CHART.JS) ---
    function actualizarGraficoPagos(efectivo, tarjeta) {
        const ctx = document.getElementById('chartPagos').getContext('2d');
        if (chartPagos) chartPagos.destroy();
        chartPagos = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Efectivo', 'Tarjeta'],
                datasets: [{
                    data: [efectivo, tarjeta],
                    backgroundColor: ['#00C853', '#00E0D0'],
                    borderWidth: 0
                }]
            },
            options: { cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: '#9CA3AF', font: { size: 10 } } } } }
        });
    }

    function actualizarGraficoSemanal(labels, montos) {
        const ctx = document.getElementById('chartSemanal').getContext('2d');
        if (chartSemanal) chartSemanal.destroy();
        chartSemanal = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ingresos',
                    data: montos,
                    borderColor: '#00E0D0',
                    backgroundColor: 'rgba(0, 224, 208, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: { 
                plugins: { legend: { display: false } },
                scales: { 
                    y: { display: false },
                    x: { ticks: { color: '#9CA3AF', font: { size: 9 } }, grid: { display: false } }
                }
            }
        });
    }

    // --- SEGURIDAD: VERIFICACIÓN DE PIN ---
    async function verificarClave() {
        const passIngresada = document.getElementById('input-pass').value;
        const errorMsg = document.getElementById('error-pass');
        
        try {
            const docRef = doc(db, "configuracion", "seguridad");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists() && passIngresada === docSnap.data().pin.toString()) {
                document.getElementById('pantalla-bloqueo').style.display = 'none';
                sessionStorage.setItem('autenticado_admin', 'true');
                // Al entrar con éxito, activamos las escuchas de datos
                iniciarEscuchaDashboard();
                iniciarEscuchaHistoricos();
            } else {
                errorMsg.classList.remove('hidden');
                errorMsg.innerText = "PIN Incorrecto";
            }
        } catch (e) {
            console.error(e);
            errorMsg.classList.remove('hidden');
            errorMsg.innerText = "Error de conexión con Firebase";
        }
    }

    // Eventos de botones
    document.getElementById('btn-entrar').onclick = verificarClave;
    
    // Si ya estaba autenticado
    if (sessionStorage.getItem('autenticado_admin') === 'true') {
        document.getElementById('pantalla-bloqueo').style.display = 'none';
        iniciarEscuchaDashboard();
        iniciarEscuchaHistoricos();
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW fail', err));
        });
    }
</script>
</body>
</html>
